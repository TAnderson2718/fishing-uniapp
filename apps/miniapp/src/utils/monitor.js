/**
 * ÁõëÊéßÂëäË≠¶Â∑•ÂÖ∑
 * @description ÂÆûÊó∂ÁõëÊéßÈ°µÈù¢Âä†ËΩΩÁä∂ÊÄÅÔºåÂª∫Á´ãËá™Âä®ÂåñÂëäË≠¶Êú∫Âà∂
 */

/**
 * ÁõëÊéßÈÖçÁΩÆ
 */
const MONITOR_CONFIG = {
  // ÁõëÊéßÈó¥ÈöîÔºàÊØ´ÁßíÔºâ
  CHECK_INTERVAL: 30 * 1000, // 30Áßí
  
  // ÈîôËØØÈòàÂÄº
  ERROR_THRESHOLD: {
    API_FAILURE_RATE: 0.3,     // APIÂ§±Ë¥•ÁéáÈòàÂÄº 30%
    PAGE_LOAD_TIME: 5000,      // È°µÈù¢Âä†ËΩΩÊó∂Èó¥ÈòàÂÄº 5Áßí
    CONSECUTIVE_ERRORS: 3,     // ËøûÁª≠ÈîôËØØÊ¨°Êï∞ÈòàÂÄº
    MEMORY_USAGE: 100 * 1024 * 1024, // ÂÜÖÂ≠ò‰ΩøÁî®ÈòàÂÄº 100MB
  },
  
  // ÂëäË≠¶ÂÜ∑Âç¥Êó∂Èó¥ÔºàÊØ´ÁßíÔºâ
  ALERT_COOLDOWN: 5 * 60 * 1000, // 5ÂàÜÈíü
  
  // Êï∞ÊçÆ‰øùÁïôÊó∂Èó¥ÔºàÊØ´ÁßíÔºâ
  DATA_RETENTION: 24 * 60 * 60 * 1000, // 24Â∞èÊó∂
  
  // ÁõëÊéßÁöÑAPIÁ´ØÁÇπ
  MONITORED_APIS: [
    '/api/health',
    '/api/banners',
    '/api/articles',
    '/api/activities/published',
    '/api/posts'
  ]
}

/**
 * ÁõëÊéßÊï∞ÊçÆÂ≠òÂÇ®
 */
class MonitorStore {
  constructor() {
    this.data = {
      apiCalls: [],           // APIË∞ÉÁî®ËÆ∞ÂΩï
      pageLoads: [],          // È°µÈù¢Âä†ËΩΩËÆ∞ÂΩï
      errors: [],             // ÈîôËØØËÆ∞ÂΩï
      performance: [],        // ÊÄßËÉΩËÆ∞ÂΩï
      alerts: []              // ÂëäË≠¶ËÆ∞ÂΩï
    }
    this.lastAlertTime = {}   // ÊúÄÂêéÂëäË≠¶Êó∂Èó¥
  }

  /**
   * Ê∑ªÂä†APIË∞ÉÁî®ËÆ∞ÂΩï
   */
  addApiCall(record) {
    this.data.apiCalls.push({
      ...record,
      timestamp: Date.now()
    })
    this.cleanup()
  }

  /**
   * Ê∑ªÂä†È°µÈù¢Âä†ËΩΩËÆ∞ÂΩï
   */
  addPageLoad(record) {
    this.data.pageLoads.push({
      ...record,
      timestamp: Date.now()
    })
    this.cleanup()
  }

  /**
   * Ê∑ªÂä†ÈîôËØØËÆ∞ÂΩï
   */
  addError(record) {
    this.data.errors.push({
      ...record,
      timestamp: Date.now()
    })
    this.cleanup()
  }

  /**
   * Ê∑ªÂä†ÊÄßËÉΩËÆ∞ÂΩï
   */
  addPerformance(record) {
    this.data.performance.push({
      ...record,
      timestamp: Date.now()
    })
    this.cleanup()
  }

  /**
   * Ê∑ªÂä†ÂëäË≠¶ËÆ∞ÂΩï
   */
  addAlert(record) {
    this.data.alerts.push({
      ...record,
      timestamp: Date.now()
    })
    this.cleanup()
  }

  /**
   * Ê∏ÖÁêÜËøáÊúüÊï∞ÊçÆ
   */
  cleanup() {
    const now = Date.now()
    const cutoff = now - MONITOR_CONFIG.DATA_RETENTION

    Object.keys(this.data).forEach(key => {
      this.data[key] = this.data[key].filter(item => item.timestamp > cutoff)
    })
  }

  /**
   * Ëé∑ÂèñÁªüËÆ°Êï∞ÊçÆ
   */
  getStats(timeRange = 60 * 60 * 1000) { // ÈªòËÆ§1Â∞èÊó∂
    const now = Date.now()
    const cutoff = now - timeRange

    const recentApiCalls = this.data.apiCalls.filter(item => item.timestamp > cutoff)
    const recentErrors = this.data.errors.filter(item => item.timestamp > cutoff)
    const recentPageLoads = this.data.pageLoads.filter(item => item.timestamp > cutoff)

    return {
      apiCalls: {
        total: recentApiCalls.length,
        success: recentApiCalls.filter(item => item.success).length,
        failure: recentApiCalls.filter(item => !item.success).length,
        failureRate: recentApiCalls.length > 0 
          ? recentApiCalls.filter(item => !item.success).length / recentApiCalls.length 
          : 0,
        avgResponseTime: recentApiCalls.length > 0
          ? recentApiCalls.reduce((sum, item) => sum + (item.responseTime || 0), 0) / recentApiCalls.length
          : 0
      },
      errors: {
        total: recentErrors.length,
        byType: this.groupBy(recentErrors, 'type'),
        consecutive: this.getConsecutiveErrors()
      },
      pageLoads: {
        total: recentPageLoads.length,
        avgLoadTime: recentPageLoads.length > 0
          ? recentPageLoads.reduce((sum, item) => sum + (item.loadTime || 0), 0) / recentPageLoads.length
          : 0,
        slowLoads: recentPageLoads.filter(item => item.loadTime > MONITOR_CONFIG.ERROR_THRESHOLD.PAGE_LOAD_TIME).length
      },
      alerts: this.data.alerts.filter(item => item.timestamp > cutoff).length
    }
  }

  /**
   * ÊåâÂ≠óÊÆµÂàÜÁªÑ
   */
  groupBy(array, field) {
    return array.reduce((groups, item) => {
      const key = item[field] || 'unknown'
      groups[key] = (groups[key] || 0) + 1
      return groups
    }, {})
  }

  /**
   * Ëé∑ÂèñËøûÁª≠ÈîôËØØÊï∞
   */
  getConsecutiveErrors() {
    const recentErrors = this.data.errors
      .slice(-10) // ÊúÄËøë10‰∏™ÈîôËØØ
      .sort((a, b) => b.timestamp - a.timestamp)

    let consecutive = 0
    for (const error of recentErrors) {
      if (error.timestamp > Date.now() - 10 * 60 * 1000) { // 10ÂàÜÈíüÂÜÖ
        consecutive++
      } else {
        break
      }
    }
    return consecutive
  }
}

// ÂàõÂª∫ÁõëÊéßÂ≠òÂÇ®ÂÆû‰æã
const monitorStore = new MonitorStore()

/**
 * ÁõëÊéßÁÆ°ÁêÜÂô®
 */
export class Monitor {
  constructor() {
    this.isRunning = false
    this.intervalId = null
    this.observers = []
  }

  /**
   * ÂêØÂä®ÁõëÊéß
   */
  start() {
    if (this.isRunning) {
      return
    }

    this.isRunning = true
    this.intervalId = setInterval(() => {
      this.checkHealth()
    }, MONITOR_CONFIG.CHECK_INTERVAL)

    console.log('üìä ÁõëÊéßÁ≥ªÁªüÂ∑≤ÂêØÂä®')
  }

  /**
   * ÂÅúÊ≠¢ÁõëÊéß
   */
  stop() {
    if (!this.isRunning) {
      return
    }

    this.isRunning = false
    if (this.intervalId) {
      clearInterval(this.intervalId)
      this.intervalId = null
    }

    console.log('üìä ÁõëÊéßÁ≥ªÁªüÂ∑≤ÂÅúÊ≠¢')
  }

  /**
   * ËÆ∞ÂΩïAPIË∞ÉÁî®
   */
  recordApiCall(url, success, responseTime, error = null) {
    monitorStore.addApiCall({
      url,
      success,
      responseTime,
      error: error ? error.message : null
    })

    // Ê£ÄÊü•APIÂ§±Ë¥•Áéá
    this.checkApiFailureRate()
  }

  /**
   * ËÆ∞ÂΩïÈ°µÈù¢Âä†ËΩΩ
   */
  recordPageLoad(page, loadTime, success = true, error = null) {
    monitorStore.addPageLoad({
      page,
      loadTime,
      success,
      error: error ? error.message : null
    })

    // Ê£ÄÊü•È°µÈù¢Âä†ËΩΩÊó∂Èó¥
    if (loadTime > MONITOR_CONFIG.ERROR_THRESHOLD.PAGE_LOAD_TIME) {
      this.triggerAlert('SLOW_PAGE_LOAD', {
        page,
        loadTime,
        threshold: MONITOR_CONFIG.ERROR_THRESHOLD.PAGE_LOAD_TIME
      })
    }
  }

  /**
   * ËÆ∞ÂΩïÈîôËØØ
   */
  recordError(type, message, details = {}) {
    monitorStore.addError({
      type,
      message,
      details,
      page: this.getCurrentPage(),
      userAgent: navigator.userAgent
    })

    // Ê£ÄÊü•ËøûÁª≠ÈîôËØØ
    this.checkConsecutiveErrors()
  }

  /**
   * ËÆ∞ÂΩïÊÄßËÉΩÊï∞ÊçÆ
   */
  recordPerformance(metrics) {
    monitorStore.addPerformance({
      ...metrics,
      page: this.getCurrentPage()
    })

    // Ê£ÄÊü•ÂÜÖÂ≠ò‰ΩøÁî®
    if (metrics.memoryUsage && metrics.memoryUsage > MONITOR_CONFIG.ERROR_THRESHOLD.MEMORY_USAGE) {
      this.triggerAlert('HIGH_MEMORY_USAGE', {
        memoryUsage: metrics.memoryUsage,
        threshold: MONITOR_CONFIG.ERROR_THRESHOLD.MEMORY_USAGE
      })
    }
  }

  /**
   * ÂÅ•Â∫∑Ê£ÄÊü•
   */
  async checkHealth() {
    try {
      const stats = monitorStore.getStats()
      
      // Ê£ÄÊü•ÂêÑÈ°πÊåáÊ†á
      this.checkApiFailureRate()
      this.checkConsecutiveErrors()
      
      // ÈÄöÁü•ËßÇÂØüËÄÖ
      this.notifyObservers('health_check', stats)
      
    } catch (error) {
      console.error('ÂÅ•Â∫∑Ê£ÄÊü•Â§±Ë¥•:', error)
      this.recordError('HEALTH_CHECK_FAILED', error.message)
    }
  }

  /**
   * Ê£ÄÊü•APIÂ§±Ë¥•Áéá
   */
  checkApiFailureRate() {
    const stats = monitorStore.getStats(30 * 60 * 1000) // 30ÂàÜÈíü
    
    if (stats.apiCalls.total >= 10 && stats.apiCalls.failureRate > MONITOR_CONFIG.ERROR_THRESHOLD.API_FAILURE_RATE) {
      this.triggerAlert('HIGH_API_FAILURE_RATE', {
        failureRate: stats.apiCalls.failureRate,
        threshold: MONITOR_CONFIG.ERROR_THRESHOLD.API_FAILURE_RATE,
        totalCalls: stats.apiCalls.total,
        failedCalls: stats.apiCalls.failure
      })
    }
  }

  /**
   * Ê£ÄÊü•ËøûÁª≠ÈîôËØØ
   */
  checkConsecutiveErrors() {
    const consecutiveErrors = monitorStore.getConsecutiveErrors()
    
    if (consecutiveErrors >= MONITOR_CONFIG.ERROR_THRESHOLD.CONSECUTIVE_ERRORS) {
      this.triggerAlert('CONSECUTIVE_ERRORS', {
        count: consecutiveErrors,
        threshold: MONITOR_CONFIG.ERROR_THRESHOLD.CONSECUTIVE_ERRORS
      })
    }
  }

  /**
   * Ëß¶ÂèëÂëäË≠¶
   */
  triggerAlert(type, data) {
    const now = Date.now()
    const lastAlert = monitorStore.lastAlertTime[type] || 0
    
    // Ê£ÄÊü•ÂÜ∑Âç¥Êó∂Èó¥
    if (now - lastAlert < MONITOR_CONFIG.ALERT_COOLDOWN) {
      return
    }

    monitorStore.lastAlertTime[type] = now
    
    const alert = {
      type,
      data,
      severity: this.getAlertSeverity(type),
      page: this.getCurrentPage()
    }

    monitorStore.addAlert(alert)
    
    // ÂèëÈÄÅÂëäË≠¶
    this.sendAlert(alert)
    
    // ÈÄöÁü•ËßÇÂØüËÄÖ
    this.notifyObservers('alert', alert)
  }

  /**
   * ÂèëÈÄÅÂëäË≠¶
   */
  async sendAlert(alert) {
    try {
      // ‰ΩøÁî®ÈÄöÁü•Á≥ªÁªüÂèëÈÄÅÂëäË≠¶
      const { sendAlert } = await import('./notification.js')

      await sendAlert(alert.type, alert.severity, alert.data)

      // ‰øùÊåÅÂéüÊúâÁöÑÊéßÂà∂Âè∞ËæìÂá∫‰Ωú‰∏∫Â§áÁî®
      console.warn(`üö® ÁõëÊéßÂëäË≠¶ [${alert.type}]:`, alert.data)

    } catch (error) {
      console.error('ÂèëÈÄÅÂëäË≠¶Â§±Ë¥•:', error)
      // ÈôçÁ∫ßÂà∞ÁÆÄÂçïÁöÑÊéßÂà∂Âè∞ËæìÂá∫
      console.warn(`üö® ÁõëÊéßÂëäË≠¶ [${alert.type}]:`, alert.data)
    }
  }

  /**
   * Ëé∑ÂèñÂëäË≠¶‰∏•ÈáçÁ®ãÂ∫¶
   */
  getAlertSeverity(type) {
    const severityMap = {
      'HIGH_API_FAILURE_RATE': 'high',
      'CONSECUTIVE_ERRORS': 'high',
      'SLOW_PAGE_LOAD': 'medium',
      'HIGH_MEMORY_USAGE': 'medium',
      'HEALTH_CHECK_FAILED': 'low'
    }
    return severityMap[type] || 'low'
  }

  /**
   * Ëé∑ÂèñÂΩìÂâçÈ°µÈù¢
   */
  getCurrentPage() {
    try {
      return window.location.pathname + window.location.hash
    } catch {
      return 'unknown'
    }
  }

  /**
   * Ê∑ªÂä†ËßÇÂØüËÄÖ
   */
  addObserver(callback) {
    this.observers.push(callback)
  }

  /**
   * ÁßªÈô§ËßÇÂØüËÄÖ
   */
  removeObserver(callback) {
    this.observers = this.observers.filter(obs => obs !== callback)
  }

  /**
   * ÈÄöÁü•ËßÇÂØüËÄÖ
   */
  notifyObservers(event, data) {
    this.observers.forEach(callback => {
      try {
        callback(event, data)
      } catch (error) {
        console.error('ËßÇÂØüËÄÖÂõûË∞ÉÂ§±Ë¥•:', error)
      }
    })
  }

  /**
   * Ëé∑ÂèñÁõëÊéßÁªüËÆ°
   */
  getStats(timeRange) {
    return monitorStore.getStats(timeRange)
  }

  /**
   * Ëé∑ÂèñÂëäË≠¶ÂéÜÂè≤
   */
  getAlerts(timeRange = 24 * 60 * 60 * 1000) {
    const cutoff = Date.now() - timeRange
    return monitorStore.data.alerts.filter(alert => alert.timestamp > cutoff)
  }

  /**
   * Ê∏ÖÈô§ÊâÄÊúâÊï∞ÊçÆ
   */
  clearData() {
    monitorStore.data = {
      apiCalls: [],
      pageLoads: [],
      errors: [],
      performance: [],
      alerts: []
    }
    monitorStore.lastAlertTime = {}
  }
}

// ÂàõÂª∫ÂÖ®Â±ÄÁõëÊéßÂÆû‰æã
const monitor = new Monitor()

// Ëá™Âä®ÂêØÂä®ÁõëÊéßÔºàÂú®Áîü‰∫ßÁéØÂ¢ÉÔºâ
if (process.env.NODE_ENV === 'production') {
  monitor.start()
}

export { monitor, MONITOR_CONFIG }
export default monitor
